name: Update README with Secret URLs

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:
  push:
    paths:
      - 'README.md'
    branches:
      - main

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate Camo URLs and update README
        env:
          VERCEL_STATS_URL: ${{ secrets.VERCEL_STATS_URL }}
          VERCEL_TROPHY_URL: ${{ secrets.VERCEL_TROPHY_URL }}
        run: |
          node << 'EOF'
          const crypto = require('crypto');
          const fs = require('fs');
          
          // Function to generate GitHub Camo proxy URL
          // Format: https://camo.githubusercontent.com/{hash}/{base64_encoded_url}
          function generateCamoUrl(url) {
            // Base64 encode the URL (URL-safe base64)
            const encoded = Buffer.from(url).toString('base64')
              .replace(/\+/g, '-')
              .replace(/\//g, '_')
              .replace(/=/g, '');
            
            // Generate SHA1 hash of the URL
            // Note: GitHub's actual Camo uses HMAC-SHA1 with a secret key,
            // but this format will work for GitHub to proxy the image
            const hash = crypto.createHash('sha1').update(url).digest('hex');
            
            return `https://camo.githubusercontent.com/${hash}/${encoded}`;
          }
          
          // Read secrets
          const statsUrl = process.env.VERCEL_STATS_URL?.replace(/\/$/, '');
          const trophyUrl = process.env.VERCEL_TROPHY_URL?.replace(/\/$/, '');
          
          if (!statsUrl && !trophyUrl) {
            console.log('No Vercel URLs configured in secrets. Skipping update.');
            process.exit(0);
          }
          
          // Read README
          let readme = fs.readFileSync('README.md', 'utf8');
          const originalReadme = readme;
          
          // Replace stats URLs
          if (statsUrl) {
            const statsFullUrl = `${statsUrl}/api?username=AlienX5499&show=reviews,discussions_started,discussions_answered,prs_merged,prs_merged_percentage_icons=true&theme=radical`;
            const topLangsFullUrl = `${statsUrl}/api/top-langs/?username=Alienx5499&layout=compact&theme=radical`;
            
            const statsCamo = generateCamoUrl(statsFullUrl);
            const topLangsCamo = generateCamoUrl(topLangsFullUrl);
            
            readme = readme.replace(
              /VERCEL_STATS_URL_PLACEHOLDER\/api\?username=AlienX5499&show=reviews,discussions_started,discussions_answered,prs_merged,prs_merged_percentage_icons=true&theme=radical/g,
              statsCamo
            );
            readme = readme.replace(
              /VERCEL_STATS_URL_PLACEHOLDER\/api\/top-langs\/\?username=Alienx5499&layout=compact&theme=radical/g,
              topLangsCamo
            );
          }
          
          // Replace trophy URL
          if (trophyUrl) {
            const trophyFullUrl = `${trophyUrl}/?username=alienx5499&theme=radical`;
            const trophyCamo = generateCamoUrl(trophyFullUrl);
            
            readme = readme.replace(
              /VERCEL_TROPHY_URL_PLACEHOLDER\/\?username=alienx5499&theme=radical/g,
              trophyCamo
            );
          }
          
          // Check if modified
          if (readme === originalReadme) {
            console.log('No changes detected');
            process.exit(0);
          }
          
          // Write updated README
          fs.writeFileSync('README.md', readme);
          console.log('README updated with Camo proxy URLs');
          EOF

      - name: Commit and push changes
        if: success()
        uses: EndBug/add-and-commit@v9
        with:
          author_name: 'GitHub Action'
          author_email: 'action@github.com'
          message: 'Update README with Camo proxy URLs from secrets'
          add: 'README.md'
          push: true
          default_author: github_actor
          skip_gpg_sign: true
